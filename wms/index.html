<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="src/style.css">
  <title>WMS QR Scanner</title>
</head>

<body class="container my-4">
  <h1 class="text-center mb-4">Leitor QR Code</h1>

  <div class="mb-4">
    <label for="nome-qr" class="form-label">Nome do produto (QR)</label>
    <input type="text" id="nome-qr" class="form-control mb-2" placeholder="Nome do produto (QR)" />
    <div id="reader" class="border p-3" style="width: 300px;"></div>
    <button class="btn btn-primary mt-3" onclick="iniciarLeitor()">Ler QR Code</button>
  </div>

  <h2 class="mt-5">Cadastro Manual</h2>
  <form id="form-produto" class="row g-3">
    <div class="col-md-6">
      <label for="nome" class="form-label">Nome do produto:</label>
      <input type="text" id="nome" class="form-control" placeholder="Nome do produto" required />
    </div>
    <div class="col-md-6">
      <label for="codigo" class="form-label">Código do produto:</label>
      <input type="text" id="codigo" class="form-control" placeholder="Código do produto" required />
    </div>
    <div class="col-md-4">
      <label for="quantidade" class="form-label">Quantidade:</label>
      <input type="number" id="quantidade" class="form-control" placeholder="Quantidade" required />
    </div>
    <div class="col-md-8">
      <label for="descricao" class="form-label">Descrição:</label>
      <input type="text" id="descricao" class="form-control" placeholder="Descrição" />
    </div>
    <div class="col-md-6">
      <label for="rua" class="form-label">Rua (ex: A, B, C...):</label>
      <input type="text" id="rua" class="form-control" placeholder="Rua (ex: A, B, C...)" />
    </div>
    <div class="col-md-6">
      <label for="nivel" class="form-label">Nível:</label>
      <input type="text" id="nivel" class="form-control" placeholder="Nível" />
    </div>
    <div class="col-12">
      <button type="submit" class="btn btn-success">Cadastrar</button>
    </div>
  </form>
  <p id="mensagem" class="mt-3"></p>

  <h2 class="mt-5">Estoque cadastrado</h2>
  <table class="table table-striped table-bordered mt-3" id="tabela-produtos">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Nome</th>
        <th>Código</th>
        <th>Quantidade</th>
        <th>Descrição</th>
        <th>Rua</th>
        <th>Nível</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button class="btn btn-danger mt-3" onclick="deletarTodosProdutos()">Deletar Todos os Produtos</button>

  <script type="module">
    import { Html5Qrcode } from "html5-qrcode";

    const form = document.getElementById("form-produto");
    const mensagem = document.getElementById("mensagem");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const nome = document.getElementById("nome").value;
      const codigo = document.getElementById("codigo").value;
      const quantidade = parseInt(document.getElementById("quantidade").value);
      const descricao = document.getElementById("descricao").value;
      const rua = document.getElementById("rua").value;
      const nivel = document.getElementById("nivel").value;

      const resposta = await fetch("http://localhost:3001/produtos", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nome, codigo, quantidade, descricao, rua, nivel }),
      });

      if (resposta.ok) {
        mensagem.textContent = "✅ Produto cadastrado com sucesso!";
        form.reset();
        carregarProdutos(); // Atualiza a tabela
      } else {
        mensagem.textContent = "❌ Erro ao cadastrar o produto.";
      }
    });

    async function carregarProdutos() {
      const resposta = await fetch("http://localhost:3001/produtos");
      const produtos = await resposta.json();

      const tbody = document.querySelector("#tabela-produtos tbody");
      tbody.innerHTML = "";

      produtos.forEach((produto) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${produto.id}</td>
          <td>${produto.nome}</td>
          <td>${produto.codigo}</td>
          <td>${produto.quantidade}</td>
          <td>${produto.descricao}</td>
          <td>${produto.rua}</td>
          <td>${produto.nivel}</td>
        `;
        tbody.appendChild(tr);
      });
    }
    carregarProdutos();

    const iniciarLeitor = async () => {
      const qrCodeScanner = new Html5Qrcode("reader");

      try {
        await qrCodeScanner.start(
          { facingMode: "environment" }, // câmera traseira
          { fps: 10, qrbox: 250 },
          async (decodedText) => {
            console.log("Código lido:", decodedText);

            const nome = document.getElementById("nome-qr").value;
            const codigo = decodedText;
            const quantidade = 1; // ou permita o usuário escolher
            const descricao = ""; // Adicione lógica para obter descrição, se necessário
            const rua = ""; // Adicione lógica para obter rua, se necessário
            const nivel = ""; // Adicione lógica para obter nível, se necessário

            // Envia pro backend
            const resposta = await fetch("http://localhost:3001/produtos", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ nome, descricao, codigo, rua, nivel, quantidade }),
            });

            if (resposta.ok) {
              alert("Produto cadastrado com sucesso!");
              await qrCodeScanner.stop(); // para o scanner
              carregarProdutos(); // Atualiza a tabela
            } else {
              alert("Erro ao cadastrar produto.");
            }
          },
          (errorMessage) => {
            console.warn("Erro de leitura:", errorMessage);
          }
        );
      } catch (err) {
        console.error("Erro ao iniciar o leitor:", err);
      }
    };

    window.deletarTodosProdutos = async function () {
      const resposta = await fetch("http://localhost:3001/produtos", {
        method: "DELETE",
      });
      if (resposta.ok) {
        alert("Todos os produtos foram apagados!");
        carregarProdutos(); // atualiza a tabela
      } else {
        alert("Erro ao apagar os produtos.");
      }
    };
  </script>
</body>

</html>